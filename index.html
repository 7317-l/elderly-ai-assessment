<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€å¹´äººå†…åœ¨èƒ½åŠ› AI è¯„ä¼°ç³»ç»Ÿ</title>
    <!-- å¼•å…¥ MediaPipe Pose ç”¨äºåŠ¨ä½œè¯†åˆ« -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <style>
        :root {
            --primary: #2E86AB;
            --accent: #A23B72;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
        }
        body {
            font-family: "Microsoft YaHei", sans-serif;
            background: #F4F7F6;
            margin: 0;
            font-size: 18px;
        }
        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .container {
            max-width: 950px;
            margin: 20px auto;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-top: 5px solid var(--primary);
        }
        .step-badge {
            background: var(--primary);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 15px;
        }
        h2 { color: var(--primary); margin-top: 0; }
        h3 { color: var(--accent); border-left: 4px solid var(--accent); padding-left: 10px; }
        
        .form-group {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .form-group label {
            flex: 0 0 140px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            flex: 1;
            padding: 12px;
            font-size: 1.1rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            min-width: 200px;
        }
        .bmi-box {
            background: #eef2f5;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            color: var(--primary);
            margin-left: 15px;
        }
        
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 15px 35px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-next { background: var(--primary); }
        .btn-success { background: var(--success); }
        
        .test-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px dashed #ddd;
        }
        .test-section.complete {
            border: 2px solid var(--success);
            background: #e8f8f0;
        }
        
        #videoElement {
            width: 100%;
            max-width: 640px;
            border-radius: 10px;
            background: #000;
            display: none;
            margin: 15px auto;
        }
        #output_canvas {
            width: 100%;
            max-width: 640px;
            border-radius: 10px;
            display: none;
            margin: 15px auto;
        }
        
        .status-box {
            padding: 15px;
            background: white;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: bold;
        }
        .status-waiting { color: #666; }
        .status-running { color: var(--warning); }
        .status-done { color: var(--success); }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #ddd;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s;
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .report-table th, .report-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .report-table th { background: #f2f2f2; }
        
        .risk-low { color: var(--success); font-weight: bold; }
        .risk-mid { color: var(--warning); font-weight: bold; }
        .risk-high { color: var(--danger); font-weight: bold; }
        
        .test-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .test-nav button {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            background: #eee;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
        }
        .test-nav button.active {
            background: var(--primary);
            color: white;
        }
        .test-nav button.completed {
            background: var(--success);
            color: white;
        }
        
        @media print {
            .btn, header, .no-print, .test-nav { display: none; }
            .card { box-shadow: none; border: 1px solid #ccc; }
        }
    </style>
</head>
<body>

<header>
    <h1>ğŸ‘´ğŸ‘µ è€å¹´äººå†…åœ¨èƒ½åŠ› AI è¯„ä¼°ç³»ç»Ÿ</h1>
    <p>åŸºäº ICOPE æ ‡å‡† Â· å¤šæ¨¡æ€å®¢è§‚æµ‹é‡ Â· æœ¬åœŸåŒ–ä¸“å®¶å…±è¯†</p>
</header>

<div class="container">

    <!-- æ­¥éª¤ 1: åŸºç¡€ä¿¡æ¯ -->
    <div class="card" id="step1">
        <span class="step-badge">æ­¥éª¤ 1/4</span>
        <h2>ğŸ“ åŸºç¡€ä¿¡æ¯é‡‡é›†</h2>
        <div class="form-group">
            <label>å§“åï¼š</label>
            <input type="text" id="userName" placeholder="è¯·è¾“å…¥å§“å">
        </div>
        <div class="form-group">
            <label>å¹´é¾„ï¼š</label>
            <input type="number" id="userAge" placeholder="å²" style="max-width:100px;">
        </div>
        <div class="form-group">
            <label>æ€§åˆ«ï¼š</label>
            <select id="userGender">
                <option value="ç”·">ç”·</option>
                <option value="å¥³">å¥³</option>
            </select>
        </div>
        <div class="form-group">
            <label>èº«é«˜ (cm)ï¼š</label>
            <input type="number" id="userHeight" placeholder="cm" style="max-width:150px;" oninput="calcBMI()">
        </div>
        <div class="form-group">
            <label>ä½“é‡ (kg)ï¼š</label>
            <input type="number" id="userWeight" placeholder="kg" style="max-width:150px;" oninput="calcBMI()">
            <div id="bmiResult" class="bmi-box">BMI: --</div>
        </div>
        <div class="form-group">
            <label>æ…¢æ€§ç—…å²ï¼š</label>
            <input type="text" id="userDiseases" placeholder="å¦‚ï¼šé«˜è¡€å‹ã€ç³–å°¿ç—… (æ— åˆ™å¡«æ— )">
        </div>
        <button class="btn btn-next" onclick="goToStep(2)">ä¸‹ä¸€æ­¥ï¼šAI æ ¸å¿ƒæµ‹è¯•</button>
    </div>

    <!-- æ­¥éª¤ 2: AI æ ¸å¿ƒæµ‹è¯• -->
    <div class="card" id="step2" style="display:none;">
        <span class="step-badge">æ­¥éª¤ 2/4</span>
        <h2>ğŸ¤– AI æ ¸å¿ƒèƒ½åŠ›æµ‹è¯• (å®¢è§‚æµ‹é‡)</h2>
        <p style="color:#666;">* ä»¥ä¸‹æµ‹è¯•é€šè¿‡æ‘„åƒå¤´å’Œéº¦å…‹é£è‡ªåŠ¨é‡‡é›†æ•°æ®ï¼Œå‡å°‘ä¸»è§‚åå·®</p>
        
        <div class="test-nav">
            <button id="nav-test1" class="active" onclick="showTest(1)">1ï¸âƒ£ è¯­è¨€è®¤çŸ¥</button>
            <button id="nav-test2" onclick="showTest(2)">2ï¸âƒ£ è¡ŒåŠ¨èƒ½åŠ›</button>
            <button id="nav-test3" onclick="showTest(3)">3ï¸âƒ£ æ´»åŠ›æ­¥é€Ÿ</button>
        </div>

        <!-- æµ‹è¯• 1: è¯­è¨€è®¤çŸ¥ -->
        <div id="test1" class="test-section">
            <h3>ğŸ—£ï¸ è¯­è¨€è®¤çŸ¥æµ‹è¯• (è®¯é£è¯­éŸ³è¯†åˆ«)</h3>
            <p>è¯·æ¸…æ™°æœ—è¯»ä»¥ä¸‹å¥å­ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯„ä¼°è¯­è¨€æµç•…åº¦</p>
            <div style="background:white; padding:20px; border-radius:8px; font-size:1.4rem; font-weight:bold; margin:15px 0;">
                "ä»Šå¤©çš„å¤©æ°”å¾ˆå¥½ï¼Œæˆ‘æƒ³å»å…¬å›­æ•£æ­¥ï¼Œçœ‹çœ‹èŠ±è‰æ ‘æœ¨ã€‚"
            </div>
            <div id="langStatus" class="status-box status-waiting">çŠ¶æ€ï¼šç­‰å¾…å¼€å§‹</div>
            <button id="btnLang" class="btn" onclick="startLangTest()">ğŸ¤ å¼€å§‹å½•éŸ³æµ‹è¯•</button>
        </div>

        <!-- æµ‹è¯• 2: è¡ŒåŠ¨èƒ½åŠ› -->
        <div id="test2" class="test-section" style="display:none;">
            <h3>ğŸƒ è¡ŒåŠ¨èƒ½åŠ›æµ‹è¯• (5 æ¬¡æ¤…å­ç«™ç«‹)</h3>
            <p>è¯·é¢å¯¹æ‘„åƒå¤´ï¼ŒåŒæ‰‹æŠ±èƒ¸ï¼Œä»æ¤…å­ä¸Šå®Œæˆ 5 æ¬¡èµ·ç«‹åä¸‹åŠ¨ä½œ</p>
            <video id="videoElement" autoplay playsinline></video>
            <canvas id="output_canvas"></canvas>
            <div id="actionStatus" class="status-box status-waiting">çŠ¶æ€ï¼šç­‰å¾…å¼€å§‹</div>
            <div class="progress-bar"><div id="actionProgress" class="progress-fill"></div></div>
            <div id="actionCount" style="font-size:1.5rem; font-weight:bold; color:var(--primary);">å®Œæˆæ¬¡æ•°ï¼š0/5</div>
            <button id="btnAction" class="btn" onclick="startActionTest()">ğŸ“¹ å¼€å¯æ‘„åƒå¤´æµ‹è¯•</button>
        </div>

        <!-- æµ‹è¯• 3: æ´»åŠ›æ­¥é€Ÿ -->
        <div id="test3" class="test-section" style="display:none;">
            <h3>ğŸš¶ æ´»åŠ›/æ­¥é€Ÿæµ‹è¯• (4 ç±³è¡Œèµ°)</h3>
            <p>è¯·åœ¨æ‘„åƒå¤´å‰è¡Œèµ° 4 ç±³è·ç¦»ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—æ­¥é€Ÿ</p>
            <p style="color:#666; font-size:0.9rem;">* éœ€è¦çº¦ 4 ç±³ç©ºé—´ï¼Œè¯·ç¡®ä¿å®‰å…¨</p>
            <video id="videoElement2" autoplay playsinline></video>
            <canvas id="output_canvas2"></canvas>
            <div id="gaitStatus" class="status-box status-waiting">çŠ¶æ€ï¼šç­‰å¾…å¼€å§‹</div>
            <div class="progress-bar"><div id="gaitProgress" class="progress-fill"></div></div>
            <div id="gaitSpeed" style="font-size:1.5rem; font-weight:bold; color:var(--primary);">æ­¥é€Ÿï¼š-- m/s</div>
            <button id="btnGait" class="btn" onclick="startGaitTest()">ğŸ“¹ å¼€å¯æ‘„åƒå¤´æµ‹è¯•</button>
        </div>

        <div style="margin-top:30px; text-align:center;">
            <button id="btnToStep3" class="btn btn-next" disabled onclick="goToStep(3)">âœ… å…¨éƒ¨å®Œæˆï¼Œè¿›å…¥ä¸‹ä¸€æ­¥</button>
        </div>
    </div>

    <!-- æ­¥éª¤ 3: è¡¥å……é—®å· -->
    <div class="card" id="step3" style="display:none;">
        <span class="step-badge">æ­¥éª¤ 3/4</span>
        <h2>ğŸ“‹ è¡¥å……ä¿¡æ¯ (è‡ªæˆ‘æŠ¥å‘Š)</h2>
        <p style="color:#666;">* ä»¥ä¸‹ç»´åº¦éœ€è¦è€äººæˆ–å®¶å±é…åˆå¡«å†™</p>
        
        <h3>æ„Ÿå®˜åŠŸèƒ½è¯„ä¼°</h3>
        <div class="form-group">
            <label>è§†åŠ›çŠ¶å†µï¼š</label>
            <select id="dimVision">
                <option value="normal">æ­£å¸¸ (èƒ½çœ‹æ¸…æŠ¥çº¸æ–‡å­—)</option>
                <option value="impaired">å—æŸ (å³ä½¿æˆ´çœ¼é•œä¹Ÿçœ‹ä¸æ¸…)</option>
            </select>
        </div>
        <div class="form-group">
            <label>å¬åŠ›çŠ¶å†µï¼š</label>
            <select id="dimHearing">
                <option value="normal">æ­£å¸¸ (èƒ½å¬æ¸…æ­£å¸¸å¯¹è¯)</option>
                <option value="impaired">å—æŸ (å³ä½¿æˆ´åŠ©å¬å™¨ä¹Ÿå¬ä¸æ¸…)</option>
            </select>
        </div>
        
        <h3>å…¶ä»–å¥åº·ä¿¡æ¯</h3>
        <div class="form-group">
            <label>è¿‘æœŸä½“é‡å˜åŒ–ï¼š</label>
            <select id="dimWeightChange">
                <option value="normal">æ— æ˜æ˜¾å˜åŒ–</option>
                <option value="loss">ä¸‹é™è¶…è¿‡ 3kg</option>
            </select>
        </div>
        <div class="form-group">
            <label>æƒ…ç»ªçŠ¶æ€ï¼š</label>
            <select id="dimMood">
                <option value="normal">æƒ…ç»ªç¨³å®š</option>
                <option value="low">ç»å¸¸æ„Ÿåˆ°ä½è½/ç„¦è™‘</option>
            </select>
        </div>

        <button class="btn btn-next" onclick="goToStep(4)">ç”Ÿæˆç»¼åˆæŠ¥å‘Š</button>
    </div>

    <!-- æ­¥éª¤ 4: æŠ¥å‘Š -->
    <div class="card" id="step4" style="display:none;">
        <span class="step-badge">æ­¥éª¤ 4/4</span>
        <h2>ğŸ“„ å†…åœ¨èƒ½åŠ›è¯„ä¼°æŠ¥å‘Š</h2>
        <div id="reportContent"></div>
        <div class="no-print">
            <button class="btn btn-success" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°/ä¿å­˜ PDF</button>
            <button class="btn" style="background:#666;" onclick="location.reload()">ğŸ”„ é‡æ–°è¯„ä¼°</button>
        </div>
    </div>

</div>

<script>
// ================= å…¨å±€æ•°æ® =================
let data = {
    basic: {},
    aiTests: {
        language: { done: false, score: 0, text: '' },
        action: { done: false, score: 0, time: 0 },
        gait: { done: false, score: 0, speed: 0 }
    },
    questionnaire: {}
};

// ================= é¡µé¢å¯¼èˆª =================
function goToStep(step) {
    // éªŒè¯
    if(step === 2) {
        if(!document.getElementById('userName').value || !document.getElementById('userAge').value) {
            alert('è¯·å¡«å†™å®Œæ•´åŸºç¡€ä¿¡æ¯'); return;
        }
        data.basic = {
            name: document.getElementById('userName').value,
            age: document.getElementById('userAge').value,
            gender: document.getElementById('userGender').value,
            height: document.getElementById('userHeight').value,
            weight: document.getElementById('userWeight').value,
            bmi: document.getElementById('bmiResult').innerText,
            diseases: document.getElementById('userDiseases').value
        };
    }
    if(step === 4) {
        data.questionnaire = {
            vision: document.getElementById('dimVision').value,
            hearing: document.getElementById('dimHearing').value,
            weightChange: document.getElementById('dimWeightChange').value,
            mood: document.getElementById('dimMood').value
        };
        generateReport();
    }
    
    document.querySelectorAll('.card').forEach(el => el.style.display = 'none');
    document.getElementById('step' + step).style.display = 'block';
    window.scrollTo(0, 0);
}

function showTest(testNum) {
    document.getElementById('test1').style.display = 'none';
    document.getElementById('test2').style.display = 'none';
    document.getElementById('test3').style.display = 'none';
    document.getElementById('test' + testNum).style.display = 'block';
    
    document.querySelectorAll('.test-nav button').forEach((btn, i) => {
        btn.classList.remove('active');
        if(i + 1 === testNum) btn.classList.add('active');
    });
}

// ================= BMI è®¡ç®— =================
function calcBMI() {
    const h = document.getElementById('userHeight').value;
    const w = document.getElementById('userWeight').value;
    const display = document.getElementById('bmiResult');
    if(h && w && h > 0) {
        const bmi = (w / ((h/100) ** 2)).toFixed(1);
        let status = bmi < 18.5 ? '(åç˜¦)' : bmi < 24 ? '(æ­£å¸¸)' : '(è¶…é‡)';
        display.innerText = `BMI: ${bmi} ${status}`;
    } else {
        display.innerText = 'BMI: --';
    }
}

// ================= æµ‹è¯• 1: è¯­è¨€è®¤çŸ¥ (è®¯é£) =================
function startLangTest() {
    const btn = document.getElementById('btnLang');
    const status = document.getElementById('langStatus');
    
    btn.disabled = true;
    status.className = 'status-box status-running';
    status.innerText = 'ğŸ”´ æ­£åœ¨å½•éŸ³è¯†åˆ«ä¸­...';
    
    // ã€å®é™…å¯å®ç°ã€‘è¿™é‡Œè¿æ¥è®¯é£ WebSocket API
    // éœ€è¦ï¼šAPP_ID, API_KEY, API_SECRET
    // ç¤ºä¾‹ä»£ç ç»“æ„ï¼š
    /*
    const ws = new WebSocket('wss://iat-api.xfyun.cn/v2/iat');
    // å‘é€éŸ³é¢‘æµ...
    // æ¥æ”¶è¯†åˆ«ç»“æœ...
    */
    
    // æ¨¡æ‹Ÿè¯†åˆ«è¿‡ç¨‹ (æ¼”ç¤ºç”¨)
    setTimeout(() => {
        const recognizedText = "ä»Šå¤©çš„å¤©æ°”å¾ˆå¥½ï¼Œæˆ‘æƒ³å»å…¬å›­æ•£æ­¥ï¼Œçœ‹çœ‹èŠ±è‰æ ‘æœ¨ã€‚";
        data.aiTests.language = {
            done: true,
            score: 95,
            text: recognizedText
        };
        
        status.className = 'status-box status-done';
        status.innerHTML = `âœ… è¯†åˆ«æˆåŠŸ<br>å†…å®¹ï¼š"${recognizedText}"<br>æµç•…åº¦è¯„åˆ†ï¼š95/100`;
        btn.innerText = 'âœ… å·²å®Œæˆ';
        btn.classList.add('btn-success');
        
        document.getElementById('nav-test1').classList.add('completed');
        checkAllTestsComplete();
    }, 2500);
}

// ================= æµ‹è¯• 2: è¡ŒåŠ¨èƒ½åŠ› (MediaPipe Pose) =================
let pose = null;
let camera = null;
let standCount = 0;
let isStanding = true;

function startActionTest() {
    const btn = document.getElementById('btnAction');
    const status = document.getElementById('actionStatus');
    const video = document.getElementById('videoElement');
    const canvas = document.getElementById('output_canvas');
    
    btn.disabled = true;
    status.className = 'status-box status-running';
    status.innerText = 'ğŸ“¹ æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´å’Œå§¿æ€è¯†åˆ«æ¨¡å‹...';
    
    // åˆå§‹åŒ– MediaPipe Pose
    pose = new Pose({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
    }});
    
    pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });
    
    pose.onResults(onActionResults);
    
    // å¯åŠ¨æ‘„åƒå¤´
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } })
            .then(function(stream) {
                video.srcObject = stream;
                video.style.display = 'block';
                canvas.style.display = 'block';
                
                camera = new Camera(video, {
                    onFrame: async () => { await pose.send({image: video}); },
                    width: 640,
                    height: 480
                });
                camera.start();
                
                status.innerText = 'âœ… æ‘„åƒå¤´å·²å¯åŠ¨ï¼Œè¯·å¼€å§‹åšæ¤…å­ç«™ç«‹åŠ¨ä½œ';
                
                // æ¨¡æ‹Ÿè®¡æ•°è¿‡ç¨‹
                simulateStandCount();
            })
            .catch(function(error) {
                status.innerText = 'âŒ æ‘„åƒå¤´è®¿é—®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™';
                status.className = 'status-box status-waiting';
                btn.disabled = false;
            });
    }
}

function onActionResults(results) {
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 640;
    canvas.height = 480;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
    
    if (results.poseLandmarks) {
        drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 3});
        drawLandmarks(ctx, results.poseLandmarks, {color: '#FF0000', lineWidth: 1});
        
        // æ£€æµ‹èµ·ç«‹åŠ¨ä½œ (é¼»å­ vs è‡€éƒ¨ Y åæ ‡)
        const noseY = results.poseLandmarks[0].y;
        const hipY = (results.poseLandmarks[23].y + results.poseLandmarks[24].y) / 2;
        
        if (noseY < hipY - 0.05) {
            if (!isStanding) {
                isStanding = true;
                // ä»ååˆ°ç«™
            }
        } else {
            isStanding = false;
        }
    }
}

function simulateStandCount() {
    let count = 0;
    const interval = setInterval(() => {
        count++;
        standCount = count;
        document.getElementById('actionCount').innerText = `å®Œæˆæ¬¡æ•°ï¼š${count}/5`;
        document.getElementById('actionProgress').style.width = (count * 20) + '%';
        
        if (count >= 5) {
            clearInterval(interval);
            finishActionTest();
        }
    }, 1500);
}

function finishActionTest() {
    const btn = document.getElementById('btnAction');
    const status = document.getElementById('actionStatus');
    
    if (camera) camera.stop();
    document.getElementById('videoElement').style.display = 'none';
    document.getElementById('output_canvas').style.display = 'none';
    
    const mockTime = 12.8; // ç§’
    const score = mockTime < 10 ? 95 : mockTime < 15 ? 80 : 60;
    
    data.aiTests.action = {
        done: true,
        score: score,
        time: mockTime
    };
    
    status.className = 'status-box status-done';
    status.innerHTML = `âœ… æµ‹è¯•å®Œæˆ<br>è€—æ—¶ï¼š${mockTime}ç§’<br>è¯„åˆ†ï¼š${score}/100`;
    btn.innerText = 'âœ… å·²å®Œæˆ';
    btn.classList.add('btn-success');
    
    document.getElementById('nav-test2').classList.add('completed');
    checkAllTestsComplete();
}

// ================= æµ‹è¯• 3: æ´»åŠ›æ­¥é€Ÿ (MediaPipe Pose) =================
let pose2 = null;
let camera2 = null;

function startGaitTest() {
    const btn = document.getElementById('btnGait');
    const status = document.getElementById('gaitStatus');
    const video = document.getElementById('videoElement2');
    const canvas = document.getElementById('output_canvas2');
    
    btn.disabled = true;
    status.className = 'status-box status-running';
    status.innerText = 'ğŸ“¹ æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...';
    
    pose2 = new Pose({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
    }});
    
    pose2.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });
    
    pose2.onResults(onGaitResults);
    
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } })
            .then(function(stream) {
                video.srcObject = stream;
                video.style.display = 'block';
                canvas.style.display = 'block';
                
                camera2 = new Camera(video, {
                    onFrame: async () => { await pose2.send({image: video}); },
                    width: 640,
                    height: 480
                });
                camera2.start();
                
                status.innerText = 'âœ… æ‘„åƒå¤´å·²å¯åŠ¨ï¼Œè¯·ä»ç”»é¢ä¸€ä¾§èµ°åˆ°å¦ä¸€ä¾§ (çº¦ 4 ç±³)';
                
                simulateGaitTest();
            })
            .catch(function(error) {
                status.innerText = 'âŒ æ‘„åƒå¤´è®¿é—®å¤±è´¥';
                btn.disabled = false;
            });
    }
}

function onGaitResults(results) {
    const canvas = document.getElementById('output_canvas2');
    const ctx = canvas.getContext('2d');
    canvas.width = 640;
    canvas.height = 480;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
    
    if (results.poseLandmarks) {
        drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 3});
    }
}

function simulateGaitTest() {
    let progress = 0;
    const interval = setInterval(() => {
        progress += 10;
        document.getElementById('gaitProgress').style.width = progress + '%';
        
        if (progress >= 100) {
            clearInterval(interval);
            finishGaitTest();
        }
    }, 500);
}

function finishGaitTest() {
    const btn = document.getElementById('btnGait');
    const status = document.getElementById('gaitStatus');
    
    if (camera2) camera2.stop();
    document.getElementById('videoElement2').style.display = 'none';
    document.getElementById('output_canvas2').style.display = 'none';
    
    const mockSpeed = 1.1; // m/s
    const score = mockSpeed >= 1.0 ? 90 : mockSpeed >= 0.8 ? 75 : 55;
    
    data.aiTests.gait = {
        done: true,
        score: score,
        speed: mockSpeed
    };
    
    status.className = 'status-box status-done';
    status.innerHTML = `âœ… æµ‹è¯•å®Œæˆ<br>æ­¥é€Ÿï¼š${mockSpeed} m/s<br>è¯„åˆ†ï¼š${score}/100`;
    document.getElementById('gaitSpeed').innerText = `æ­¥é€Ÿï¼š${mockSpeed} m/s`;
    btn.innerText = 'âœ… å·²å®Œæˆ';
    btn.classList.add('btn-success');
    
    document.getElementById('nav-test3').classList.add('completed');
    checkAllTestsComplete();
}

// ================= æ£€æŸ¥æ‰€æœ‰æµ‹è¯•å®Œæˆ =================
function checkAllTestsComplete() {
    const allDone = data.aiTests.language.done && 
                    data.aiTests.action.done && 
                    data.aiTests.gait.done;
    
    const btn = document.getElementById('btnToStep3');
    btn.disabled = !allDone;
    if(allDone) {
        btn.innerText = 'âœ… å…¨éƒ¨å®Œæˆï¼Œè¿›å…¥ä¸‹ä¸€æ­¥';
        btn.classList.add('btn-success');
    }
}

// ================= ç”ŸæˆæŠ¥å‘Š =================
function generateReport() {
    const d = data;
    const date = new Date().toLocaleDateString();
    
    // è®¡ç®—ç»¼åˆé£é™©
    const avgScore = Math.round((d.aiTests.language.score + d.aiTests.action.score + d.aiTests.gait.score) / 3);
    let riskLevel = avgScore >= 85 ? 'ä½é£é™© (å†…åœ¨èƒ½åŠ›å®Œå¥½)' : avgScore >= 70 ? 'ä¸­é£é™© (èƒ½åŠ›ä¸‹é™)' : 'é«˜é£é™© (éœ€å¹²é¢„)';
    let riskColor = avgScore >= 85 ? 'risk-low' : avgScore >= 70 ? 'risk-mid' : 'risk-high';
    
    const html = `
        <div style="text-align:center; border-bottom:2px solid #333; padding-bottom:20px; margin-bottom:20px;">
            <h3>è€å¹´äººå†…åœ¨èƒ½åŠ›ç»¼åˆè¯„ä¼°æŠ¥å‘Š</h3>
            <p>ä¾æ®ï¼šã€Šè€å¹´äººå†…åœ¨èƒ½åŠ›ç­›æŸ¥ä¸ç»¼åˆè¯„ä¼°ä¸­å›½ä¸“å®¶å…±è¯†ã€‹& WHO ICOPE æŒ‡å—</p>
            <p>è¯„ä¼°æ—¥æœŸï¼š${date} | å§“åï¼š${d.basic.name} | å¹´é¾„ï¼š${d.basic.age}å² | æ€§åˆ«ï¼š${d.basic.gender}</p>
        </div>
        
        <table class="report-table">
            <thead>
                <tr><th>è¯„ä¼°ç»´åº¦</th><th>æµ‹é‡æ–¹å¼</th><th>ç»“æœæ•°æ®</th><th>è¯„ä¼°ç»“è®º</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>1. è®¤çŸ¥èƒ½åŠ›</strong></td>
                    <td>è®¯é£è¯­éŸ³è¯†åˆ«</td>
                    <td>å‡†ç¡®ç‡ ${d.aiTests.language.score}%</td>
                    <td class="${d.aiTests.language.score >= 80 ? 'risk-low' : 'risk-mid'}">${d.aiTests.language.score >= 80 ? 'æ­£å¸¸' : 'éœ€å…³æ³¨'}</td>
                </tr>
                <tr>
                    <td><strong>2. è¡ŒåŠ¨èƒ½åŠ›</strong></td>
                    <td>5 æ¬¡æ¤…å­ç«™ç«‹ (è§†è§‰)</td>
                    <td>${d.aiTests.action.time}ç§’</td>
                    <td class="${d.aiTests.action.score >= 80 ? 'risk-low' : 'risk-mid'}">${d.aiTests.action.score >= 80 ? 'æ­£å¸¸' : 'ä¸‹é™'}</td>
                </tr>
                <tr>
                    <td><strong>3. æ´»åŠ›/æ­¥é€Ÿ</strong></td>
                    <td>4 ç±³è¡Œèµ°æµ‹è¯• (è§†è§‰)</td>
                    <td>${d.aiTests.gait.speed} m/s</td>
                    <td class="${d.aiTests.gait.score >= 80 ? 'risk-low' : 'risk-mid'}">${d.aiTests.gait.score >= 80 ? 'æ­£å¸¸' : 'ç¼“æ…¢'}</td>
                </tr>
                <tr>
                    <td><strong>4. è¥å…»çŠ¶å†µ</strong></td>
                    <td>BMI + ä½“é‡å˜åŒ–</td>
                    <td>${d.basic.bmi}</td>
                    <td class="${d.questionnaire.weightChange === 'normal' ? 'risk-low' : 'risk-mid'}">${d.questionnaire.weightChange === 'normal' ? 'æ­£å¸¸' : 'ä½“é‡ä¸‹é™'}</td>
                </tr>
                <tr>
                    <td><strong>5. æ„Ÿå®˜åŠŸèƒ½</strong></td>
                    <td>è‡ªæˆ‘æŠ¥å‘Š</td>
                    <td>è§†åŠ›ï¼š${d.questionnaire.vision === 'normal' ? 'æ­£å¸¸' : 'å—æŸ'}<br>å¬åŠ›ï¼š${d.questionnaire.hearing === 'normal' ? 'æ­£å¸¸' : 'å—æŸ'}</td>
                    <td class="${d.questionnaire.vision === 'normal' && d.questionnaire.hearing === 'normal' ? 'risk-low' : 'risk-mid'}">${d.questionnaire.vision === 'normal' && d.questionnaire.hearing === 'normal' ? 'æ­£å¸¸' : 'éœ€å…³æ³¨'}</td>
                </tr>
            </tbody>
        </table>
        
        <div style="background:#f8f9fa; padding:20px; border-radius:8px; margin-top:20px;">
            <h3 style="margin-top:0;">ğŸ“Š ç»¼åˆè¯„ä¼°ç»“è®º</h3>
            <p style="font-size:1.4rem; font-weight:bold;" class="${riskColor}">å†…åœ¨èƒ½åŠ›ç­‰çº§ï¼š${riskLevel}</p>
            <p><strong>æ…¢æ€§ç—…å²ï¼š</strong>${d.basic.diseases || 'æ— '}</p>
            <p><strong>å¹³å‡å¾—åˆ†ï¼š</strong>${avgScore}/100</p>
            <hr>
            <h4>ğŸ’¡ æœ¬åœŸåŒ– AI å»ºè®® (åŸºäº ICOPE æŒ‡å—)</h4>
            <ul>
                <li>${d.aiTests.action.score < 80 ? 'âš ï¸ <strong>è¡ŒåŠ¨èƒ½åŠ›ï¼š</strong>å»ºè®®è¿›è¡Œ Vivifrail å¤šç»„åˆ†è¿åŠ¨è®­ç»ƒï¼Œé¢„é˜²è·Œå€’é£é™©ã€‚' : 'âœ… <strong>è¡ŒåŠ¨èƒ½åŠ›ï¼š</strong>ä¿æŒå½“å‰æ´»åŠ¨æ°´å¹³ï¼Œé¼“åŠ±æ—¥å¸¸é”»ç‚¼ã€‚'}</li>
                <li>${d.aiTests.gait.score < 80 ? 'âš ï¸ <strong>æ´»åŠ›æ­¥é€Ÿï¼š</strong>æ­¥é€Ÿåæ…¢ï¼Œå»ºè®®å¢åŠ æœ‰æ°§è¿åŠ¨å’Œå¹³è¡¡è®­ç»ƒã€‚' : 'âœ… <strong>æ´»åŠ›æ­¥é€Ÿï¼š</strong>æ­¥é€Ÿæ­£å¸¸ï¼Œç»§ç»­ä¿æŒã€‚'}</li>
                <li>${d.questionnaire.weightChange === 'loss' ? 'âš ï¸ <strong>è¥å…»çŠ¶å†µï¼š</strong>è¿‘æœŸä½“é‡ä¸‹é™ï¼Œå»ºè®®è¥å…»ç§‘å°±è¯Šã€‚' : 'âœ… <strong>è¥å…»çŠ¶å†µï¼š</strong>ä½“é‡ç¨³å®šï¼Œä¿æŒå‡è¡¡é¥®é£Ÿã€‚'}</li>
                <li>ğŸ“Œ å»ºè®®å°†æœ¬è¯„ä¼°ç»“æœçº³å…¥ç¤¾åŒºå¥åº·æ¡£æ¡ˆï¼Œå®šæœŸéšè®¿ç›‘æµ‹ã€‚</li>
                <li>ğŸ“Œ å¦‚æœ‰éœ€è¦ï¼Œå¯è½¬è¯Šè‡³åŒ»ç–—æœºæ„åˆ¶å®šä¸ªæ€§åŒ–æŠ¤ç†è®¡åˆ’ã€‚</li>
            </ul>
        </div>
        
        <div style="margin-top:20px; padding:15px; background:#fff3cd; border-radius:6px; font-size:0.9rem;">
            <strong>âš ï¸ å…è´£å£°æ˜ï¼š</strong>æœ¬è¯„ä¼°ç»“æœä»…ä¾›å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç–—è¯Šæ–­ã€‚å¦‚æœ‰å¥åº·é—®é¢˜è¯·å’¨è¯¢åŒ»ç–—æœºæ„ã€‚
        </div>
    `;
    
    document.getElementById('reportContent').innerHTML = html;
}
</script>

</body>
</html>
