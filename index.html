<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€å¹´äººå†…åœ¨èƒ½åŠ› AI è¯„ä¼°ç³»ç»Ÿ</title>
    <!-- å¼•å…¥ MediaPipe ä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <!-- å¼•å…¥ Chart.js (æŒ‡å®šç¨³å®šç‰ˆæœ¬ v3.9.1) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        :root {
            --primary: #2E86AB;
            --accent: #A23B72;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
        }
        body {
            font-family: "Microsoft YaHei", sans-serif;
            background: #F4F7F6;
            margin: 0;
            font-size: 18px;
        }
        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .container {
            max-width: 950px;
            margin: 20px auto;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-top: 5px solid var(--primary);
        }
        .step-badge {
            background: var(--primary);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 15px;
        }
        h2 { color: var(--primary); margin-top: 0; }
        h3 { 
            color: var(--accent); 
            border-left: 4px solid var(--accent); 
            padding-left: 10px; 
            margin-top: 25px;
            background: #f9f9f9;
            padding: 10px 10px 10px 15px;
            border-radius: 0 8px 8px 0;
        }
        
        .form-group {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .form-group label {
            flex: 0 0 140px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            flex: 1;
            padding: 12px;
            font-size: 1.1rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            min-width: 200px;
        }
        .bmi-box {
            background: #eef2f5;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            color: var(--primary);
            margin-left: 15px;
        }
        
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 15px 35px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        .btn:hover:not(:disabled) {
            opacity: 0.9;
        }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-next { background: var(--primary); }
        .btn-success { background: var(--success); }
        
        .test-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px dashed #ddd;
        }
        .test-section.complete {
            border: 2px solid var(--success);
            background: #e8f8f0;
        }
        
        #videoElement, #videoElement2 {
            width: 100%;
            max-width: 640px;
            border-radius: 10px;
            background: #000;
            display: none;
            margin: 15px auto;
            transform: scaleX(-1);
        }
        #output_canvas, #output_canvas2 {
            width: 100%;
            max-width: 640px;
            border-radius: 10px;
            display: none;
            margin: 15px auto;
            transform: scaleX(-1);
        }
        
        .status-box {
            padding: 15px;
            background: white;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: bold;
        }
        .status-waiting { color: #666; }
        .status-running { color: var(--warning); }
        .status-done { color: var(--success); }
        .status-error { color: var(--danger); }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #ddd;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s;
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .report-table th, .report-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .report-table th { background: #f2f2f2; }
        
        .risk-low { color: var(--success); font-weight: bold; }
        .risk-mid { color: var(--warning); font-weight: bold; }
        .risk-high { color: var(--danger); font-weight: bold; }
        
        .test-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .test-nav button {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            background: #eee;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }
        .test-nav button:hover:not(.active):not(.completed) {
            background: #ddd;
        }
        .test-nav button.active {
            background: var(--primary);
            color: white;
        }
        .test-nav button.completed {
            background: var(--success);
            color: white;
        }

        .questionnaire-section {
            background: #fff;
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .questionnaire-section h3 {
            margin-top: 0;
            background: var(--primary);
            color: white;
            border-left: none;
            padding: 10px 15px;
            border-radius: 8px 8px 0 0;
        }
        .question-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid var(--accent);
        }
        .question-item label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .question-item select {
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            border: 2px solid #ddd;
            border-radius: 6px;
        }

        .task-list {
            margin-top: 15px;
        }
        .task-item {
            display: flex;
            align-items: center;
            background: white;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .task-item.checked {
            background: #e8f8f0;
            color: #27ae60;
            text-decoration: line-through;
        }
        .task-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }
        .task-item label {
            flex: 1;
            cursor: pointer;
            font-weight: normal;
        }
        .task-item .task-desc {
            font-size: 0.9rem;
            color: #666;
            margin-top: 3px;
        }

        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ä¿®å¤å›¾è¡¨å®¹å™¨æ ·å¼ */
        .chart-container {
            position: relative;
            height: 400px; /* å›ºå®šé«˜åº¦é˜²æ­¢å¡Œé™· */
            width: 100%;
            margin: 0 auto 20px;
            max-width: 600px;
        }

        @media print {
            .btn, header, .no-print, .test-nav, .loading-overlay { display: none; }
            .card { box-shadow: none; border: 1px solid #ccc; }
        }
    </style>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay">
    <div style="text-align:center;">
        <div class="loading-spinner"></div>
        <p style="margin-top:15px; font-weight:bold; color:var(--primary);">æ­£åœ¨ç”ŸæˆæŠ¥å‘Šï¼Œè¯·ç¨å€™...</p>
    </div>
</div>

<header>
    <h1>ğŸ‘´ğŸ‘µ è€å¹´äººå†…åœ¨èƒ½åŠ› AI è¯„ä¼°ç³»ç»Ÿ</h1>
    <p>åŸºäº ICOPE æ ‡å‡† Â· å¤šæ¨¡æ€å®¢è§‚æµ‹é‡ Â· æœ¬åœŸåŒ–ä¸“å®¶å…±è¯†</p>
</header>

<div class="container">

    <!-- æ­¥éª¤ 1: åŸºç¡€ä¿¡æ¯ -->
    <div class="card" id="step1">
        <span class="step-badge">æ­¥éª¤ 1/4</span>
        <h2>ğŸ“ åŸºç¡€ä¿¡æ¯é‡‡é›†</h2>
        <div class="form-group">
            <label>å§“åï¼š</label>
            <input type="text" id="userName" placeholder="è¯·è¾“å…¥å§“å">
        </div>
        <div class="form-group">
            <label>å¹´é¾„ï¼š</label>
            <input type="number" id="userAge" placeholder="å²" style="max-width:100px;" min="60" max="120">
        </div>
        <div class="form-group">
            <label>æ€§åˆ«ï¼š</label>
            <select id="userGender">
                <option value="ç”·">ç”·</option>
                <option value="å¥³">å¥³</option>
            </select>
        </div>
        <div class="form-group">
            <label>èº«é«˜ (cm)ï¼š</label>
            <input type="number" id="userHeight" placeholder="cm" style="max-width:150px;" oninput="calcBMI()" min="100" max="250">
        </div>
        <div class="form-group">
            <label>ä½“é‡ (kg)ï¼š</label>
            <input type="number" id="userWeight" placeholder="kg" style="max-width:150px;" oninput="calcBMI()" min="30" max="200">
            <div id="bmiResult" class="bmi-box">BMI: --</div>
        </div>
        <div class="form-group">
            <label>æ…¢æ€§ç—…å²ï¼š</label>
            <input type="text" id="userDiseases" placeholder="å¦‚ï¼šé«˜è¡€å‹ã€ç³–å°¿ç—… (æ— åˆ™å¡«æ— )">
        </div>
        <button class="btn btn-next" onclick="goToStep(2)">ä¸‹ä¸€æ­¥ï¼šAI æ ¸å¿ƒæµ‹è¯•</button>
    </div>

    <!-- æ­¥éª¤ 2: AI æ ¸å¿ƒæµ‹è¯• -->
    <div class="card" id="step2" style="display:none;">
        <span class="step-badge">æ­¥éª¤ 2/4</span>
        <h2>ğŸ¤– AI æ ¸å¿ƒèƒ½åŠ›æµ‹è¯• (å®¢è§‚æµ‹é‡)</h2>
        <p style="color:#666;">* ä»¥ä¸‹æµ‹è¯•é€šè¿‡æ‘„åƒå¤´å’Œéº¦å…‹é£è‡ªåŠ¨é‡‡é›†æ•°æ®ï¼Œå‡å°‘ä¸»è§‚åå·®</p>
        
        <div class="test-nav">
            <button id="nav-test1" class="active" onclick="showTest(1)">1ï¸âƒ£ è¯­è¨€è®¤çŸ¥</button>
            <button id="nav-test2" onclick="showTest(2)">2ï¸âƒ£ è¡ŒåŠ¨èƒ½åŠ›</button>
            <button id="nav-test3" onclick="showTest(3)">3ï¸âƒ£ æ´»åŠ›æ­¥é€Ÿ</button>
        </div>

        <div id="test1" class="test-section">
            <h3>ğŸ—£ï¸ è¯­è¨€è®¤çŸ¥æµ‹è¯•</h3>
            <p>è¯·æ¸…æ™°æœ—è¯»ä»¥ä¸‹å¥å­ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯„ä¼°è¯­è¨€æµç•…åº¦</p>
            <div style="background:white; padding:20px; border-radius:8px; font-size:1.4rem; font-weight:bold; margin:15px 0;">
                "ä»Šå¤©çš„å¤©æ°”å¾ˆå¥½ï¼Œæˆ‘æƒ³å»å…¬å›­æ•£æ­¥ï¼Œçœ‹çœ‹èŠ±è‰æ ‘æœ¨ã€‚"
            </div>
            <div id="langStatus" class="status-box status-waiting">çŠ¶æ€ï¼šç­‰å¾…å¼€å§‹</div>
            <button id="btnLang" class="btn" onclick="startLangTest()">ğŸ¤ å¼€å§‹å½•éŸ³æµ‹è¯•</button>
        </div>

        <div id="test2" class="test-section" style="display:none;">
            <h3>ğŸƒ è¡ŒåŠ¨èƒ½åŠ›æµ‹è¯• (5 æ¬¡æ¤…å­ç«™ç«‹)</h3>
            <p>è¯·é¢å¯¹æ‘„åƒå¤´ï¼ŒåŒæ‰‹æŠ±èƒ¸ï¼Œä»æ¤…å­ä¸Šå®Œæˆ 5 æ¬¡èµ·ç«‹åä¸‹åŠ¨ä½œ</p>
            <video id="videoElement" autoplay playsinline></video>
            <canvas id="output_canvas"></canvas>
            <div id="actionStatus" class="status-box status-waiting">çŠ¶æ€ï¼šç­‰å¾…å¼€å§‹</div>
            <div class="progress-bar"><div id="actionProgress" class="progress-fill"></div></div>
            <div id="actionCount" style="font-size:1.5rem; font-weight:bold; color:var(--primary);">å®Œæˆæ¬¡æ•°ï¼š0/5</div>
            <button id="btnAction" class="btn" onclick="startActionTest()">ğŸ“¹ å¼€å¯æ‘„åƒå¤´æµ‹è¯•</button>
        </div>

        <div id="test3" class="test-section" style="display:none;">
            <h3>ğŸš¶ æ´»åŠ›/æ­¥é€Ÿæµ‹è¯• (4 ç±³è¡Œèµ°)</h3>
            <p>è¯·åœ¨æ‘„åƒå¤´å‰è¡Œèµ° 4 ç±³è·ç¦»ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—æ­¥é€Ÿ</p>
            <p style="color:#666; font-size:0.9rem;">* éœ€è¦çº¦ 4 ç±³ç©ºé—´ï¼Œè¯·ç¡®ä¿å®‰å…¨</p>
            <video id="videoElement2" autoplay playsinline></video>
            <canvas id="output_canvas2"></canvas>
            <div id="gaitStatus" class="status-box status-waiting">çŠ¶æ€ï¼šç­‰å¾…å¼€å§‹</div>
            <div class="progress-bar"><div id="gaitProgress" class="progress-fill"></div></div>
            <div id="gaitSpeed" style="font-size:1.5rem; font-weight:bold; color:var(--primary);">æ­¥é€Ÿï¼š-- m/s</div>
            <button id="btnGait" class="btn" onclick="startGaitTest()">ğŸ“¹ å¼€å¯æ‘„åƒå¤´æµ‹è¯•</button>
        </div>

        <div style="margin-top:30px; text-align:center;">
            <button id="btnToStep3" class="btn btn-next" disabled onclick="goToStep(3)">âœ… å…¨éƒ¨å®Œæˆï¼Œè¿›å…¥é—®å·</button>
        </div>
    </div>

    <!-- æ­¥éª¤ 3: æ ‡å‡†åŒ–é—®å· -->
    <div class="card" id="step3" style="display:none;">
        <span class="step-badge">æ­¥éª¤ 3/4</span>
        <h2>ğŸ“‹ æ ‡å‡†åŒ–å¥åº·é—®å·</h2>
        <p style="color:#666; background:#fff3cd; padding:10px; border-radius:6px;">
            â„¹ï¸ ä»¥ä¸‹é—®å·åŸºäº WHO ICOPE æ ‡å‡†ï¼Œè¯·è€äººæˆ–å®¶å±å¦‚å®å¡«å†™
        </p>
        
        <div class="questionnaire-section">
            <h3>ğŸ‘ï¸ æ„Ÿå®˜åŠŸèƒ½è¯„ä¼° (å½±å“ç¤¾ä¼šäº¤å¾€)</h3>
            <div class="question-item">
                <label>1. è§†åŠ›æµ‹è¯•ï¼šä¸æˆ´çœ¼é•œæ—¶ï¼Œèƒ½å¦çœ‹æ¸…ä¸€è‡‚è·ç¦»çš„æ‰‹æœºæ–‡å­—ï¼Ÿ</label>
                <select id="q_vision">
                    <option value="2">âœ… èƒ½çœ‹æ¸… (2 åˆ†)</option>
                    <option value="1">âš ï¸ æœ‰ç‚¹æ¨¡ç³Š (1 åˆ†)</option>
                    <option value="0">âŒ çœ‹ä¸æ¸… (0 åˆ†)</option>
                </select>
            </div>
            <div class="question-item">
                <label>2. å¬åŠ›æµ‹è¯•ï¼šä¸æˆ´åŠ©å¬å™¨æ—¶ï¼Œèƒ½å¦å¬æ¸…æ­£å¸¸éŸ³é‡çš„å¯¹è¯ï¼Ÿ</label>
                <select id="q_hearing">
                    <option value="2">âœ… èƒ½å¬æ¸… (2 åˆ†)</option>
                    <option value="1">âš ï¸ éœ€è¦é‡å¤ (1 åˆ†)</option>
                    <option value="0">âŒ å¬ä¸æ¸… (0 åˆ†)</option>
                </select>
            </div>
        </div>
        
        <div class="questionnaire-section">
            <h3>ğŸ§  å¿ƒç†æ´»åŠ›è¯„ä¼°</h3>
            <p style="color:#666; font-size:0.9rem;">* åŸºäº PHQ-2 æŠ‘éƒç­›æŸ¥é‡è¡¨</p>
            <div class="question-item">
                <label>3. è¿‡å» 2 å‘¨ï¼Œæ˜¯å¦ç»å¸¸æ„Ÿåˆ°æƒ…ç»ªä½è½ã€æ²®ä¸§æˆ–æ— æœ›ï¼Ÿ</label>
                <select id="q_mood1">
                    <option value="0">âœ… å®Œå…¨ä¸ä¼š (0 åˆ†)</option>
                    <option value="1">âš ï¸ å¶å°”å‡ å¤© (1 åˆ†)</option>
                    <option value="2">âŒ ç»å¸¸å¦‚æ­¤ (2 åˆ†)</option>
                </select>
            </div>
            <div class="question-item">
                <label>4. è¿‡å» 2 å‘¨ï¼Œæ˜¯å¦å¯¹åšäº‹æƒ…æä¸èµ·å…´è¶£æˆ–ä¹è¶£ï¼Ÿ</label>
                <select id="q_mood2">
                    <option value="0">âœ… å®Œå…¨ä¸ä¼š (0 åˆ†)</option>
                    <option value="1">âš ï¸ å¶å°”å‡ å¤© (1 åˆ†)</option>
                    <option value="2">âŒ ç»å¸¸å¦‚æ­¤ (2 åˆ†)</option>
                </select>
            </div>
            <div class="question-item">
                <label>5. è¿‘æœŸæ˜¯å¦æ„Ÿåˆ°å®¹æ˜“ç–²åŠ³ã€ç²¾åŠ›ä¸è¶³ï¼Ÿ</label>
                <select id="q_energy">
                    <option value="0">âœ… ç²¾åŠ›å……æ²› (0 åˆ†)</option>
                    <option value="1">âš ï¸ æœ‰æ—¶ç–²åŠ³ (1 åˆ†)</option>
                    <option value="2">âŒ ç»å¸¸ç–²åŠ³ (2 åˆ†)</option>
                </select>
            </div>
        </div>
        
        <div class="questionnaire-section">
            <h3>ğŸ è¥å…»çŠ¶å†µè¯„ä¼°</h3>
            <div class="question-item">
                <label>6. è¿‡å» 3 ä¸ªæœˆä½“é‡æ˜¯å¦æœ‰æ˜æ˜¾å˜åŒ–ï¼Ÿ</label>
                <select id="q_weight">
                    <option value="0">âœ… æ— æ˜æ˜¾å˜åŒ– (0 åˆ†)</option>
                    <option value="2">âš ï¸ ä¸‹é™ 3kg ä»¥ä¸Š (2 åˆ†)</option>
                    <option value="1">âš ï¸ å¢åŠ  3kg ä»¥ä¸Š (1 åˆ†)</option>
                </select>
            </div>
            <div class="question-item">
                <label>7. è¿‘æœŸé£Ÿæ¬²å¦‚ä½•ï¼Ÿ</label>
                <select id="q_appetite">
                    <option value="0">âœ… é£Ÿæ¬²æ­£å¸¸ (0 åˆ†)</option>
                    <option value="1">âš ï¸ é£Ÿæ¬²ä¸€èˆ¬ (1 åˆ†)</option>
                    <option value="2">âŒ é£Ÿæ¬²æ˜æ˜¾ä¸‹é™ (2 åˆ†)</option>
                </select>
            </div>
        </div>

        <button class="btn btn-next" onclick="goToStep(4)">ç”Ÿæˆç»¼åˆæŠ¥å‘Š</button>
    </div>

    <!-- æ­¥éª¤ 4: æŠ¥å‘Š -->
    <div class="card" id="step4" style="display:none;">
        <span class="step-badge">æ­¥éª¤ 4/4</span>
        <h2>ğŸ“„ å†…åœ¨èƒ½åŠ›è¯„ä¼°æŠ¥å‘Š</h2>
        
        <!-- ä¿®å¤ï¼šå¢åŠ  chart-container ç±»åå’Œå›ºå®šé«˜åº¦ -->
        <div class="chart-container">
            <h3 style="text-align: center; color: var(--primary);">ğŸ“ˆ äº”å¤§ç»´åº¦èƒ½åŠ›é›·è¾¾å›¾ (0-10 åˆ†)</h3>
            <canvas id="abilityRadarChart"></canvas>
        </div>
        
        <!-- å¹²é¢„ä»»åŠ¡è¡¨å®¹å™¨ -->
        <div style="background: #f5fafe; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h3 style="color: var(--primary); margin-top: 0;">âœ… ä¸ªæ€§åŒ–å¹²é¢„ä»»åŠ¡è¡¨</h3>
            <p style="color: #666;">æ ¹æ®æ‚¨çš„è¯„ä¼°ç»“æœç”Ÿæˆï¼Œå®Œæˆåå‹¾é€‰å³å¯æ ‡ç»¿è®°å½•</p>
            <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px;">
                <div style="flex: 1; min-width: 300px;">
                    <h4 style="color: var(--accent); border-bottom: 2px solid #eee; padding-bottom: 10px;">æ¯æ—¥ä»»åŠ¡</h4>
                    <div id="dailyTasks" class="task-list"></div>
                </div>
                <div style="flex: 1; min-width: 300px;">
                    <h4 style="color: var(--accent); border-bottom: 2px solid #eee; padding-bottom: 10px;">æ¯å‘¨ä»»åŠ¡</h4>
                    <div id="weeklyTasks" class="task-list"></div>
                </div>
            </div>
        </div>
        
        <div id="reportContent"></div>
        <div class="no-print">
            <button class="btn btn-success" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°/ä¿å­˜ PDF</button>
            <button class="btn" style="background:#666;" onclick="location.reload()">ğŸ”„ é‡æ–°è¯„ä¼°</button>
        </div>
    </div>

</div>

<script>
// ================= å…¨å±€æ•°æ® =================
let data = {
    basic: {},
    aiTests: {
        language: { done: false, score: 0, text: '' },
        action: { done: false, score: 0, time: 0 },
        gait: { done: false, score: 0, speed: 0 }
    },
    questionnaire: {}
};

let drawConnectors = window.drawConnectors || function() {};
let POSE_CONNECTIONS = window.POSE_CONNECTIONS || [];
let pose = null;
let camera = null;
let pose2 = null;
let camera2 = null;
let radarChart = null;

// ================= é¡µé¢å¯¼èˆª =================
function goToStep(step) {
    if(step === 2) {
        const name = document.getElementById('userName').value.trim();
        const age = document.getElementById('userAge').value.trim();
        if(!name || !age) {
            alert('è¯·å¡«å†™å®Œæ•´çš„å§“åå’Œå¹´é¾„ä¿¡æ¯ï¼');
            return;
        }
        data.basic = {
            name: name,
            age: age,
            gender: document.getElementById('userGender').value,
            height: document.getElementById('userHeight').value || 0,
            weight: document.getElementById('userWeight').value || 0,
            bmi: document.getElementById('bmiResult').innerText,
            diseases: document.getElementById('userDiseases').value || 'æ— '
        };
    }
    if(step === 4) {
        data.questionnaire = {
            vision: parseInt(document.getElementById('q_vision').value),
            hearing: parseInt(document.getElementById('q_hearing').value),
            mood1: parseInt(document.getElementById('q_mood1').value),
            mood2: parseInt(document.getElementById('q_mood2').value),
            energy: parseInt(document.getElementById('q_energy').value),
            weight: parseInt(document.getElementById('q_weight').value),
            appetite: parseInt(document.getElementById('q_appetite').value)
        };
        
        // å…ˆæ˜¾ç¤ºåŠ è½½å±‚
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        // å…ˆåˆ‡æ¢é¡µé¢æ˜¾ç¤ºï¼Œç¡®ä¿ DOM å­˜åœ¨
        document.querySelectorAll('.card').forEach(el => el.style.display = 'none');
        document.getElementById('step' + step).style.display = 'block';
        window.scrollTo(0, 0);

        // å»¶è¿Ÿæ‰§è¡Œç”Ÿæˆé€»è¾‘ï¼Œç¡®ä¿ DOM æ¸²æŸ“å®Œæˆï¼Œè§£å†³ç™½å±é—®é¢˜
        setTimeout(() => {
            try {
                generateReport();
            } catch (error) {
                console.error('æŠ¥å‘Šç”Ÿæˆé”™è¯¯:', error);
                document.getElementById('reportContent').innerHTML = `<div style="color:red; padding:20px;">æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼š${error.message}<br>è¯·åˆ·æ–°é¡µé¢é‡è¯•</div>`;
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }, 100);
        
        return;
    }
    
    document.querySelectorAll('.card').forEach(el => el.style.display = 'none');
    document.getElementById('step' + step).style.display = 'block';
    window.scrollTo(0, 0);
}

function showTest(testNum) {
    document.getElementById('test1').style.display = 'none';
    document.getElementById('test2').style.display = 'none';
    document.getElementById('test3').style.display = 'none';
    document.getElementById('test' + testNum).style.display = 'block';
    
    document.querySelectorAll('.test-nav button').forEach((btn, i) => {
        btn.classList.remove('active');
        if(i + 1 === testNum) btn.classList.add('active');
    });
}

function calcBMI() {
    const h = parseFloat(document.getElementById('userHeight').value) || 0;
    const w = parseFloat(document.getElementById('userWeight').value) || 0;
    const display = document.getElementById('bmiResult');
    
    if(h > 0 && w > 0) {
        const bmi = (w / Math.pow(h/100, 2)).toFixed(1);
        let status = '';
        if (bmi < 18.5) status = '(åç˜¦)';
        else if (bmi < 24) status = '(æ­£å¸¸)';
        else if (bmi < 28) status = '(è¶…é‡)';
        else status = '(è‚¥èƒ–)';
        display.innerText = `BMI: ${bmi} ${status}`;
    } else {
        display.innerText = 'BMI: --';
    }
}

// ================= æµ‹è¯• 1: è¯­è¨€è®¤çŸ¥ =================
function startLangTest() {
    const btn = document.getElementById('btnLang');
    const status = document.getElementById('langStatus');
    btn.disabled = true;
    status.className = 'status-box status-running';
    status.innerText = 'ğŸ”´ æ­£åœ¨å½•éŸ³è¯†åˆ«ä¸­...';
    setTimeout(() => {
        const recognizedText = "ä»Šå¤©çš„å¤©æ°”å¾ˆå¥½ï¼Œæˆ‘æƒ³å»å…¬å›­æ•£æ­¥ï¼Œçœ‹çœ‹èŠ±è‰æ ‘æœ¨ã€‚";
        const mockScore = Math.floor(Math.random() * 30) + 70;
        data.aiTests.language = { done: true, score: mockScore, text: recognizedText };
        status.className = 'status-box status-done';
        status.innerHTML = `âœ… è¯†åˆ«æˆåŠŸ<br>å†…å®¹ï¼š"${recognizedText}"<br>æµç•…åº¦è¯„åˆ†ï¼š${mockScore}/100`;
        btn.innerText = 'âœ… å·²å®Œæˆ';
        btn.classList.add('btn-success');
        document.getElementById('nav-test1').classList.add('completed');
        checkAllTestsComplete();
    }, 2500);
}

// ================= æµ‹è¯• 2: è¡ŒåŠ¨èƒ½åŠ› =================
function startActionTest() {
    const btn = document.getElementById('btnAction');
    const status = document.getElementById('actionStatus');
    const video = document.getElementById('videoElement');
    const canvas = document.getElementById('output_canvas');
    btn.disabled = true;
    status.className = 'status-box status-running';
    status.innerText = 'ğŸ“¹ æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...';
    try {
        pose = new Pose({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        }});
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        pose.onResults(onActionResults);
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } })
                .then(function(stream) {
                    video.srcObject = stream;
                    video.style.display = 'block';
                    canvas.style.display = 'block';
                    camera = new Camera(video, {
                        onFrame: async () => { await pose.send({image: video}); },
                        width: 640, height: 480
                    });
                    camera.start();
                    status.innerText = 'âœ… æ‘„åƒå¤´å·²å¯åŠ¨ï¼Œè¯·å¼€å§‹åšæ¤…å­ç«™ç«‹åŠ¨ä½œ';
                    simulateStandCount();
                })
                .catch(function(error) {
                    status.className = 'status-box status-error';
                    status.innerText = 'âŒ æ‘„åƒå¤´è®¿é—®å¤±è´¥ï¼š' + error.message;
                    btn.disabled = false;
                });
        } else {
            status.className = 'status-box status-error';
            status.innerText = 'âŒ æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½';
            btn.disabled = false;
        }
    } catch (error) {
        status.className = 'status-box status-error';
        status.innerText = 'âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼š' + error.message;
        btn.disabled = false;
    }
}

function onActionResults(results) {
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 640; canvas.height = 480;
    ctx.save();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
    if (results.poseLandmarks) {
        drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 3});
    }
    ctx.restore();
}

function simulateStandCount() {
    let count = 0;
    const interval = setInterval(() => {
        count++;
        document.getElementById('actionCount').innerText = `å®Œæˆæ¬¡æ•°ï¼š${count}/5`;
        document.getElementById('actionProgress').style.width = (count * 20) + '%';
        if (count >= 5) { clearInterval(interval); finishActionTest(); }
    }, 1500);
}

function finishActionTest() {
    const btn = document.getElementById('btnAction');
    const status = document.getElementById('actionStatus');
    // å½»åº•é‡Šæ”¾èµ„æºï¼Œé˜²æ­¢å¡é¡¿
    if (camera) { camera.stop(); camera = null; }
    if (pose) { pose.close(); pose = null; }
    const video = document.getElementById('videoElement');
    if (video.srcObject) { video.srcObject.getTracks().forEach(track => track.stop()); }
    video.style.display = 'none';
    document.getElementById('output_canvas').style.display = 'none';
    
    const mockTime = (Math.random() * 7 + 8).toFixed(1);
    let score = 0;
    if (mockTime < 10) score = 95; else if (mockTime < 15) score = 80; else score = 60;
    data.aiTests.action = { done: true, score: score, time: mockTime };
    status.className = 'status-box status-done';
    status.innerHTML = `âœ… æµ‹è¯•å®Œæˆ<br>è€—æ—¶ï¼š${mockTime}ç§’<br>è¯„åˆ†ï¼š${score}/100`;
    btn.innerText = 'âœ… å·²å®Œæˆ';
    btn.classList.add('btn-success');
    document.getElementById('nav-test2').classList.add('completed');
    checkAllTestsComplete();
}

// ================= æµ‹è¯• 3: æ´»åŠ›æ­¥é€Ÿ =================
function startGaitTest() {
    const btn = document.getElementById('btnGait');
    const status = document.getElementById('gaitStatus');
    const video = document.getElementById('videoElement2');
    const canvas = document.getElementById('output_canvas2');
    btn.disabled = true;
    status.className = 'status-box status-running';
    status.innerText = 'ğŸ“¹ æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...';
    try {
        pose2 = new Pose({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        }});
        pose2.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        pose2.onResults(onGaitResults);
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } })
                .then(function(stream) {
                    video.srcObject = stream;
                    video.style.display = 'block';
                    canvas.style.display = 'block';
                    camera2 = new Camera(video, {
                        onFrame: async () => { await pose2.send({image: video}); },
                        width: 640, height: 480
                    });
                    camera2.start();
                    status.innerText = 'âœ… æ‘„åƒå¤´å·²å¯åŠ¨ï¼Œè¯·ä»ç”»é¢ä¸€ä¾§èµ°åˆ°å¦ä¸€ä¾§';
                    simulateGaitTest();
                })
                .catch(function(error) {
                    status.className = 'status-box status-error';
                    status.innerText = 'âŒ æ‘„åƒå¤´è®¿é—®å¤±è´¥ï¼š' + error.message;
                    btn.disabled = false;
                });
        } else {
            status.className = 'status-box status-error';
            status.innerText = 'âŒ æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½';
            btn.disabled = false;
        }
    } catch (error) {
        status.className = 'status-box status-error';
        status.innerText = 'âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼š' + error.message;
        btn.disabled = false;
    }
}

function onGaitResults(results) {
    const canvas = document.getElementById('output_canvas2');
    const ctx = canvas.getContext('2d');
    canvas.width = 640; canvas.height = 480;
    ctx.save();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
    if (results.poseLandmarks) {
        drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 3});
    }
    ctx.restore();
}

function simulateGaitTest() {
    let progress = 0;
    const interval = setInterval(() => {
        progress += 10;
        document.getElementById('gaitProgress').style.width = progress + '%';
        if (progress >= 100) { clearInterval(interval); finishGaitTest(); }
    }, 500);
}

function finishGaitTest() {
    const btn = document.getElementById('btnGait');
    const status = document.getElementById('gaitStatus');
    // å½»åº•é‡Šæ”¾èµ„æº
    if (camera2) { camera2.stop(); camera2 = null; }
    if (pose2) { pose2.close(); pose2 = null; }
    const video = document.getElementById('videoElement2');
    if (video.srcObject) { video.srcObject.getTracks().forEach(track => track.stop()); }
    video.style.display = 'none';
    document.getElementById('output_canvas2').style.display = 'none';
    
    const mockSpeed = (Math.random() * 0.8 + 0.6).toFixed(2);
    let score = 0;
    if (mockSpeed >= 1.0) score = 90; else if (mockSpeed >= 0.8) score = 75; else score = 55;
    data.aiTests.gait = { done: true, score: score, speed: mockSpeed };
    status.className = 'status-box status-done';
    status.innerHTML = `âœ… æµ‹è¯•å®Œæˆ<br>æ­¥é€Ÿï¼š${mockSpeed} m/s<br>è¯„åˆ†ï¼š${score}/100`;
    document.getElementById('gaitSpeed').innerText = `æ­¥é€Ÿï¼š${mockSpeed} m/s`;
    btn.innerText = 'âœ… å·²å®Œæˆ';
    btn.classList.add('btn-success');
    document.getElementById('nav-test3').classList.add('completed');
    checkAllTestsComplete();
}

function checkAllTestsComplete() {
    const allDone = data.aiTests.language.done && data.aiTests.action.done && data.aiTests.gait.done;
    const btn = document.getElementById('btnToStep3');
    btn.disabled = !allDone;
    if(allDone) {
        btn.innerText = 'âœ… å…¨éƒ¨å®Œæˆï¼Œè¿›å…¥é—®å·';
        btn.classList.add('btn-success');
    }
}

// ================= ç”ŸæˆæŠ¥å‘Š (äº”å¤§ç»´åº¦ç‰ˆ) =================
function generateReport() {
    const d = data;
    const date = new Date().toLocaleDateString('zh-CN');
    
    // è®¡ç®—å„ç»´åº¦å¾—åˆ†
    const sensoryScore = Math.round(((d.questionnaire.vision + d.questionnaire.hearing) / 4) * 100);
    const moodScore = Math.round(((6 - d.questionnaire.mood1 - d.questionnaire.mood2) / 6) * 100);
    const nutritionScore = Math.round(((4 - d.questionnaire.weight - d.questionnaire.appetite) / 4) * 100);
    
    // å°†è¡ŒåŠ¨èƒ½åŠ›å’Œæ´»åŠ›æ­¥é€Ÿåˆå¹¶ä¸º"èº«ä½“æœºèƒ½"
    const physicalScore = Math.round((d.aiTests.action.score + d.aiTests.gait.score) / 2);
    
    // ç»¼åˆå¾—åˆ† (é™¤ä»¥ 5)
    const avgScore = Math.round((
        d.aiTests.language.score + 
        physicalScore + 
        sensoryScore + 
        moodScore + 
        nutritionScore
    ) / 5);
    
    let riskLevel = '';
    let riskColor = '';
    if (avgScore >= 85) { riskLevel = 'ä½é£é™© (å†…åœ¨èƒ½åŠ›å®Œå¥½)'; riskColor = 'risk-low'; }
    else if (avgScore >= 70) { riskLevel = 'ä¸­é£é™© (èƒ½åŠ›ä¸‹é™)'; riskColor = 'risk-mid'; }
    else { riskLevel = 'é«˜é£é™© (éœ€å¹²é¢„)'; riskColor = 'risk-high'; }

    const getRiskText = (score) => score < 70 ? 'éœ€å…³æ³¨' : 'æ­£å¸¸';
    const getRiskClass = (score) => score < 70 ? 'risk-mid' : 'risk-low';

    // ç»˜åˆ¶é›·è¾¾å›¾ (5 ä¸ªç»´åº¦)
    try {
        const radarData = {
            labels: ['èº«ä½“æœºèƒ½', 'è®¤çŸ¥åŠŸèƒ½', 'è¥å…»çŠ¶å†µ', 'å¿ƒç†å¥åº·', 'ç¤¾ä¼šäº¤å¾€'],
            values: [
                Math.round(physicalScore / 10),
                Math.round(d.aiTests.language.score / 10),
                Math.round(nutritionScore / 10),
                Math.round(moodScore / 10),
                Math.round(sensoryScore / 10)
            ],
            threshold: 7,
            colors: []
        };
        radarData.values.forEach(score => {
            radarData.colors.push(score < radarData.threshold ? '#c0392b' : '#27ae60');
        });

        const ctx = document.getElementById('abilityRadarChart').getContext('2d');
        if (radarChart) radarChart.destroy();
        
        if (typeof Chart !== 'undefined') {
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: radarData.labels,
                    datasets: [{
                        label: 'èƒ½åŠ›å¾—åˆ† (é˜ˆå€¼ 7 åˆ†)',
                        data: radarData.values,
                        backgroundColor: 'rgba(46, 134, 171, 0.2)',
                        borderColor: '#2E86AB',
                        borderWidth: 2,
                        pointBackgroundColor: radarData.colors,
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: radarData.colors
                    }, {
                        label: 'é˜ˆå€¼çº¿',
                        data: Array(5).fill(radarData.threshold),
                        backgroundColor: 'rgba(192, 57, 43, 0.1)',
                        borderColor: '#c0392b',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                },
                options: {
                    // ä¼˜åŒ–ï¼šå…³é—­åŠ¨ç”»ä»¥æå‡æ€§èƒ½ï¼Œè§£å†³å¡é¡¿
                    animation: false, 
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 10,
                            ticks: { stepSize: 1, font: { size: 14 } },
                            pointLabels: { font: { size: 14, weight: 'bold' } }
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 12 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const dimension = radarData.labels[context.dataIndex];
                                    let tip = `${dimension}: ${value} åˆ†`;
                                    if (value < radarData.threshold) tip += ' (ä½äºé˜ˆå€¼ï¼Œéœ€å…³æ³¨)';
                                    return tip;
                                }
                            }
                        }
                    },
                    maintainAspectRatio: false,
                    responsive: true
                }
            });
        } else {
            throw new Error("Chart.js åº“æœªåŠ è½½æˆåŠŸ");
        }
    } catch (chartError) {
        console.error('é›·è¾¾å›¾ç»˜åˆ¶å¤±è´¥:', chartError);
        // å¦‚æœå›¾è¡¨å¤±è´¥ï¼Œåœ¨é¡µé¢æç¤ºï¼Œä½†ä¸é˜»æ­¢æŠ¥å‘Šç”Ÿæˆ
        const chartContainer = document.querySelector('.chart-container');
        if(chartContainer) {
            chartContainer.innerHTML += `<div style="color:red; text-align:center; margin-top:10px;">âš ï¸ å›¾è¡¨åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>`;
        }
    }

    // ç”Ÿæˆå¹²é¢„ä»»åŠ¡
    const tasks = { daily: [], weekly: [] };
    if (physicalScore < 80) {
        tasks.daily.push({ title: 'å¹³è¡¡è®­ç»ƒï¼šå•è…¿ç«™ç«‹', desc: 'æ¯ä¾§ç«™ç«‹ 30 ç§’ï¼Œå…± 2 ç»„ï¼Œç«™ç«‹æ—¶æ‰¶ç¨³å›ºå®šç‰©ä½“' });
        tasks.daily.push({ title: 'è‚ŒåŠ›è®­ç»ƒï¼šé å¢™é™è¹²', desc: '30 ç§’/ç»„ï¼Œ3 ç»„ï¼Œè†ç›–ä¸è¶…è¿‡è„šå°–' });
    } else {
        tasks.daily.push({ title: 'æ—¥å¸¸è¿åŠ¨ï¼šå¿«èµ° 30 åˆ†é’Ÿ', desc: 'æ­¥é€Ÿ 5-6km/hï¼Œæ™šé¥­å 1 å°æ—¶è¿›è¡Œ' });
    }
    if (d.aiTests.language.score < 80) {
        tasks.daily.push({ title: 'è®¤çŸ¥è®­ç»ƒï¼šæœ—è¯»çŸ­æ–‡', desc: 'æœ—è¯»æŠ¥çº¸/ä¹¦ç±ç‰‡æ®µ 5 åˆ†é’Ÿï¼Œé”»ç‚¼è¯­è¨€æµç•…åº¦' });
    } else {
        tasks.weekly.push({ title: 'è®¤çŸ¥ç»´æŠ¤ï¼šç›Šæ™ºæ¸¸æˆ', desc: 'ç©æ‹¼å›¾ã€æ•°ç‹¬ç­‰æ¸¸æˆ 1 æ¬¡ï¼Œæ¯æ¬¡ 15 åˆ†é’Ÿ' });
    }
    if (nutritionScore < 80) {
        tasks.daily.push({ title: 'è¥å…»è¡¥å……ï¼šä¼˜è´¨è›‹ç™½', desc: 'æ—©é¤ 1 ä¸ªé¸¡è›‹ +1 æ¯ä½è„‚ç‰›å¥¶ï¼Œä¿è¯è›‹ç™½è´¨æ‘„å…¥' });
        tasks.weekly.push({ title: 'è¥å…»ç›‘æµ‹ï¼šä½“é‡è®°å½•', desc: 'æ¯å‘¨å›ºå®šæ—¶é—´ï¼ˆæ™¨èµ·ç©ºè…¹ï¼‰æµ‹é‡ä½“é‡ 1 æ¬¡' });
    } else {
        tasks.weekly.push({ title: 'è¥å…»ç»´æŒï¼šå‡è¡¡é¥®é£Ÿ', desc: 'æ¯å‘¨è‡³å°‘åƒ 2 æ¬¡é±¼ç±»ï¼Œè¡¥å……ä¸é¥±å’Œè„‚è‚ªé…¸' });
    }
    if (moodScore < 80) {
        tasks.daily.push({ title: 'æƒ…ç»ªè°ƒèŠ‚ï¼šæ·±å‘¼å¸æ”¾æ¾', desc: 'æ—©æ™šå„ 1 æ¬¡ï¼Œæ¯æ¬¡ 5 åˆ†é’Ÿï¼Œç¼“è§£å‹åŠ›' });
        tasks.weekly.push({ title: 'ç¤¾äº¤æ´»åŠ¨ï¼šä¸äººäº¤æµ', desc: 'æ¯å‘¨ä¸äº²å‹èŠå¤©/è§é¢è‡³å°‘ 2 æ¬¡ï¼Œé¿å…å­¤ç‹¬' });
    } else {
        tasks.weekly.push({ title: 'ç¤¾äº¤ç»´æŠ¤ï¼šç¤¾åŒºæ´»åŠ¨', desc: 'å‚ä¸ç¤¾åŒºè€å¹´æ´»åŠ¨ 1 æ¬¡ï¼Œæ‹“å±•ç¤¾äº¤åœˆ' });
    }
    if (sensoryScore < 80) {
        tasks.daily.push({ title: 'æ„Ÿå®˜ä¿æŠ¤ï¼šè§†åŠ›/å¬åŠ›æŠ¤ç†', desc: 'è§†åŠ›ï¼šåšçœ¼ä¿å¥æ“ 1 æ¬¡ï¼›å¬åŠ›ï¼šé¿å…å™ªéŸ³ç¯å¢ƒ' });
    }
    tasks.daily.push({ title: 'å¥åº·ç›‘æµ‹ï¼šåŸºç¡€æŒ‡æ ‡è®°å½•', desc: 'æµ‹é‡è¡€å‹/è¡€æ°§ï¼ˆå¦‚æœ‰è®¾å¤‡ï¼‰ï¼Œè®°å½•æ•°å€¼' });
    tasks.weekly.push({ title: 'å¥åº·å¤ç›˜ï¼šä»»åŠ¡å®Œæˆæƒ…å†µ', desc: 'æŸ¥çœ‹æœ¬å‘¨ä»»åŠ¡å®Œæˆç‡ï¼Œè°ƒæ•´ä¸‹å‘¨è®¡åˆ’' });

    renderTasks(tasks);

    // ç”ŸæˆæŠ¥å‘Š HTML (5 è¡Œè¡¨æ ¼)
    const html = `
        <div style="text-align:center; border-bottom:2px solid #333; padding-bottom:20px; margin-bottom:20px;">
            <h3>è€å¹´äººå†…åœ¨èƒ½åŠ›ç»¼åˆè¯„ä¼°æŠ¥å‘Š</h3>
            <p>ä¾æ®ï¼šã€Šè€å¹´äººå†…åœ¨èƒ½åŠ›ç­›æŸ¥ä¸ç»¼åˆè¯„ä¼°ä¸­å›½ä¸“å®¶å…±è¯†ã€‹& WHO ICOPE æŒ‡å—</p>
            <p>è¯„ä¼°æ—¥æœŸï¼š${date} | å§“åï¼š${d.basic.name} | å¹´é¾„ï¼š${d.basic.age}å² | æ€§åˆ«ï¼š${d.basic.gender}</p>
            <p>BMIï¼š${d.basic.bmi} | æ…¢æ€§ç—…å²ï¼š${d.basic.diseases}</p>
        </div>
        
        <table class="report-table">
            <thead>
                <tr><th>è¯„ä¼°ç»´åº¦</th><th>æµ‹é‡æ–¹å¼</th><th>å¾—åˆ†</th><th>è¯„ä¼°ç»“è®º</th></tr>
            </thead>
            <tbody>
                <tr><td><strong>1. èº«ä½“æœºèƒ½</strong></td><td>AI è§†è§‰ (åç«™ + æ­¥é€Ÿ)</td><td>${physicalScore}/100</td><td class="${getRiskClass(physicalScore)}">${getRiskText(physicalScore)}</td></tr>
                <tr><td><strong>2. è®¤çŸ¥åŠŸèƒ½</strong></td><td>AI è¯­éŸ³è¯†åˆ«</td><td>${d.aiTests.language.score}/100</td><td class="${getRiskClass(d.aiTests.language.score)}">${getRiskText(d.aiTests.language.score)}</td></tr>
                <tr><td><strong>3. è¥å…»çŠ¶å†µ</strong></td><td>BMI+ é—®å·</td><td>${nutritionScore}/100</td><td class="${getRiskClass(nutritionScore)}">${getRiskText(nutritionScore)}</td></tr>
                <tr><td><strong>4. å¿ƒç†å¥åº·</strong></td><td>PHQ-2 é‡è¡¨</td><td>${moodScore}/100</td><td class="${getRiskClass(moodScore)}">${getRiskText(moodScore)}</td></tr>
                <tr><td><strong>5. ç¤¾ä¼šäº¤å¾€</strong></td><td>æ„Ÿå®˜åŠŸèƒ½é—®å·</td><td>${sensoryScore}/100</td><td class="${getRiskClass(sensoryScore)}">${getRiskText(sensoryScore)}</td></tr>
            </tbody>
        </table>
        
        <div style="background:#f8f9fa; padding:20px; border-radius:8px; margin-top:20px;">
            <h3 style="margin-top:0;">ğŸ“Š ç»¼åˆè¯„ä¼°ç»“è®º</h3>
            <p style="font-size:1.4rem; font-weight:bold;" class="${riskColor}">å†…åœ¨èƒ½åŠ›ç­‰çº§ï¼š${riskLevel}</p>
            <p><strong>AI ç»¼åˆå¾—åˆ†ï¼š</strong>${avgScore}/100</p>
            <hr>
            <h4>ğŸ’¡ ä¸ªæ€§åŒ–å¹²é¢„å»ºè®®</h4>
            <ul>
                <li>${physicalScore < 80 ? 'âš ï¸ <strong>èº«ä½“æœºèƒ½ï¼š</strong>å»ºè®®è¿›è¡Œå¹³è¡¡è®­ç»ƒã€å¤ªæç­‰ä½å¼ºåº¦è¿åŠ¨ï¼Œé¢„é˜²è·Œå€’ã€‚' : 'âœ… <strong>èº«ä½“æœºèƒ½ï¼š</strong>ä¿æŒå½“å‰æ´»åŠ¨æ°´å¹³ï¼Œæ¯å‘¨è‡³å°‘ 3 æ¬¡è½»åº¦è¿åŠ¨ã€‚'}</li>
                <li>${moodScore < 70 ? 'âš ï¸ <strong>å¿ƒç†å¥åº·ï¼š</strong>å»ºè®®å¢åŠ ç¤¾äº¤æ´»åŠ¨ï¼Œå‚ä¸ç¤¾åŒºè€å¹´è¯¾å ‚ï¼Œå¿…è¦æ—¶å¯»æ±‚å¿ƒç†å’¨è¯¢ã€‚' : 'âœ… <strong>å¿ƒç†å¥åº·ï¼š</strong>æƒ…ç»ªçŠ¶æ€è‰¯å¥½ï¼Œå»ºè®®ç»§ç»­ä¿æŒç¤¾äº¤äº’åŠ¨ã€‚'}</li>
                <li>${nutritionScore < 70 ? 'âš ï¸ <strong>è¥å…»çŠ¶å†µï¼š</strong>å»ºè®®è¥å…»ç§‘å°±è¯Šï¼Œè°ƒæ•´é¥®é£Ÿç»“æ„ï¼Œä¿è¯è›‹ç™½è´¨å’Œç»´ç”Ÿç´ æ‘„å…¥ã€‚' : 'âœ… <strong>è¥å…»çŠ¶å†µï¼š</strong>ä¿æŒå‡è¡¡é¥®é£Ÿï¼Œè§„å¾‹ä¸‰é¤ã€‚'}</li>
                <li>${sensoryScore < 70 ? 'âš ï¸ <strong>ç¤¾ä¼šäº¤å¾€ï¼š</strong>å»ºè®®éªŒå…‰é…é•œ/å¬åŠ›æ£€æµ‹ï¼Œæ”¹å–„è§†å¬åŠŸèƒ½ä»¥ä¿ƒè¿›ç¤¾äº¤ã€‚' : 'âœ… <strong>ç¤¾ä¼šäº¤å¾€ï¼š</strong>è§†å¬åŠŸèƒ½è‰¯å¥½ï¼Œå»ºè®®å¤šå‚ä¸ç¤¾åŒºæ´»åŠ¨ã€‚'}</li>
                <li>ğŸ“Œ å»ºè®®æ¯ 3 ä¸ªæœˆå¤æµ‹ä¸€æ¬¡ï¼ŒåŠ¨æ€ç›‘æµ‹å†…åœ¨èƒ½åŠ›å˜åŒ–ã€‚</li>
            </ul>
        </div>
        
        <div style="margin-top:20px; padding:15px; background:#fff3cd; border-radius:6px; font-size:0.9rem;">
            <strong>âš ï¸ å…è´£å£°æ˜ï¼š</strong>æœ¬è¯„ä¼°ç»“æœåŸºäº AI ç®—æ³•å’Œæ ‡å‡†åŒ–é—®å·ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç–—è¯Šæ–­ã€‚å¦‚æœ‰å¥åº·é—®é¢˜ï¼Œè¯·åŠæ—¶å’¨è¯¢åŒ»ç”Ÿã€‚
        </div>
    `;
    
    document.getElementById('reportContent').innerHTML = html;
}

function renderTasks(tasks) {
    const dailyContainer = document.getElementById('dailyTasks');
    const weeklyContainer = document.getElementById('weeklyTasks');
    dailyContainer.innerHTML = '';
    weeklyContainer.innerHTML = '';
    tasks.daily.forEach((task, index) => {
        const taskEl = document.createElement('div');
        taskEl.className = 'task-item';
        taskEl.innerHTML = `<input type="checkbox" id="daily-task-${index}"><div><label for="daily-task-${index}">${task.title}</label><div class="task-desc">${task.desc}</div></div>`;
        dailyContainer.appendChild(taskEl);
        const checkbox = taskEl.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', function() { if (this.checked) taskEl.classList.add('checked'); else taskEl.classList.remove('checked'); });
    });
    tasks.weekly.forEach((task, index) => {
        const taskEl = document.createElement('div');
        taskEl.className = 'task-item';
        taskEl.innerHTML = `<input type="checkbox" id="weekly-task-${index}"><div><label for="weekly-task-${index}">${task.title}</label><div class="task-desc">${task.desc}</div></div>`;
        weeklyContainer.appendChild(taskEl);
        const checkbox = taskEl.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', function() { if (this.checked) taskEl.classList.add('checked'); else taskEl.classList.remove('checked'); });
    });
}
</script>

</body>
</html>
